<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageMatch - Manage Filters & Uploads</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4CAF50;
            --text-color: #333;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        h1 { 
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .card {
            background-color: var(--light-bg);
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }
        
        input[type="file"] {
            padding: 8px 0;
        }
        
        /* Custom file input styling */
        .file-input-container {
            position: relative;
            margin-top: 8px;
        }
        
        .file-input-container input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }
        
        .file-input-button, .file-select-button {
            display: flex;
            align-items: center;
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 10px 15px;
            width: 100%;
            font-size: 14px;
            position: relative;
            color: #555;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .file-input-container:hover .file-input-button,
        .file-input-container:hover .file-select-button {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .file-input-button svg, .file-select-button svg {
            margin-right: 8px;
            color: var(--primary-color);
            flex-shrink: 0;
        }
        
        .file-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-left: 8px;
            margin-right: 8px;
            max-width: calc(100% - 150px);
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .remove-file-btn {
            display: none;
            align-items: center;
            justify-content: center;
            background-color: rgba(244, 67, 54, 0.1);
            color: #d32f2f;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-left: auto;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
            z-index: 3;
        }
        
        .remove-file-btn:hover {
            background-color: rgba(244, 67, 54, 0.2);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            box-shadow: var(--shadow);
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        #filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .filter-tag {
            display: inline-flex;
            align-items: center;
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 0.85rem;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .filter-tag svg {
            margin-right: 6px;
        }
        
        .delete-filter-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            color: var(--primary-color);
            transition: all 0.2s;
            box-shadow: none;
        }
        
        .delete-filter-btn:hover {
            background-color: rgba(244, 67, 54, 0.1);
            color: #d32f2f;
        }
        
        .delete-filter-btn:active {
            transform: translateY(1px);
            background-color: rgba(244, 67, 54, 0.2);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }
        
        /* Upload Progress Styles - New additions */
        .upload-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .progress-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 400px;
            max-width: 90%;
            text-align: center;
        }
        
        .progress-container p {
            margin: 10px 0;
            color: #374151;
        }
        
        progress {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            appearance: none;
        }
        
        progress::-webkit-progress-bar {
            background-color: #e5e7eb;
            border-radius: 4px;
        }
        
        progress::-webkit-progress-value {
            background-color: var(--primary-color);
            border-radius: 4px;
        }
        
        progress::-moz-progress-bar {
            background-color: var(--primary-color);
            border-radius: 4px;
        }
        
        #progress-text {
            font-size: 16px;
            font-weight: 500;
        }
        
        #progress-details {
            font-size: 14px;
            color: #6b7280;
        }
        
        /* Spinner Animation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        .nav-bar {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        .nav-bar a {
            color: var(--text-color);
            text-decoration: none;
            margin-right: 20px;
            font-weight: 600;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
        }
        
        .nav-bar a:hover {
            color: var(--primary-color);
        }
        
        .nav-bar a svg {
            margin-right: 6px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .section-header svg {
            margin-right: 10px;
        }
        
        .info-text {
            background-color: rgba(67, 97, 238, 0.1);
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 15px;
        }
        
        /* Navigation and Header Area */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        .app-title {
            margin: 0;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: var(--radius);
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
        }
        
        .nav-links a:hover {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }
        
        .nav-links a svg {
            margin-right: 6px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-color);
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1 class="app-title">ImageMatch</h1>
        <div class="nav-links">
            <a href="/">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 12L5 10M5 10L12 3L19 10M5 10V20C5 20.5523 5.44772 21 6 21H9M19 10L21 12M19 10V20C19 20.5523 18.5523 21 18 21H15M9 21C9.55228 21 10 20.5523 10 20V16C10 15.4477 10.4477 15 11 15H13C13.5523 15 14 15.4477 14 16V20C14 20.5523 14.4477 21 15 21M9 21H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Home
            </a>
            <a href="/app">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z" fill="currentColor"/>
                </svg>
                Search
            </a>
            <a href="/manage">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.3246 4.31731C10.751 2.5609 13.249 2.5609 13.6754 4.31731C13.9508 5.45193 15.2507 5.99038 16.2478 5.38285C17.7913 4.44239 19.5576 6.2087 18.6172 7.75218C18.0096 8.74925 18.5481 10.0492 19.6827 10.3246C21.4391 10.751 21.4391 13.249 19.6827 13.6754C18.5481 13.9508 18.0096 15.2507 18.6172 16.2478C19.5576 17.7913 17.7913 19.5576 16.2478 18.6172C15.2507 18.0096 13.9508 18.5481 13.6754 19.6827C13.249 21.4391 10.751 21.4391 10.3246 19.6827C10.0492 18.5481 8.74926 18.0096 7.75219 18.6172C6.2087 19.5576 4.44239 17.7913 5.38285 16.2478C5.99038 15.2507 5.45193 13.9508 4.31731 13.6754C2.5609 13.249 2.5609 10.751 4.31731 10.3246C5.45193 10.0492 5.99037 8.74926 5.38285 7.75218C4.44239 6.2087 6.2087 4.44239 7.75219 5.38285C8.74926 5.99037 10.0492 5.45193 10.3246 4.31731Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Manage
            </a>
            <a href="/images">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19ZM13.96 12.29L11.21 15.83L9.25 13.47L6.5 17H17.5L13.96 12.29Z" fill="currentColor"/>
                </svg>
                All Images
            </a>
        </div>
    </div>
    
    <!-- Upload Image Section -->
    <section>
        <div class="section-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 16H15M12 12V19M12 12L8 8M12 12L16 8M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2>Upload Images</h2>
        </div>
        
        <div class="card">
            <form action="/upload" method="post" enctype="multipart/form-data" id="upload-form">
                <div class="form-group">
                    <label for="file">Select Image</label>
                    <div class="file-input-container">
                        <div class="file-select-button">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 16L8.58579 11.4142C9.36683 10.6332 10.6332 10.6332 11.4142 11.4142L16 16M14 14L15.5858 12.4142C16.3668 11.6332 17.6332 11.6332 18.4142 12.4142L20 14M14 8H14.01M6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Choose File
                            <span class="file-name">No file selected</span>
                            <button type="button" class="remove-file-btn">×</button>
                        </div>
                        <input type="file" name="file" id="file" accept="image/*" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">Description (Optional)</label>
                    <textarea id="description" name="description" rows="3" placeholder="Enter image description"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="custom_metadata">Custom Metadata (Optional)</label>
                    <textarea id="custom_metadata" name="custom_metadata" rows="3" placeholder="Enter any additional metadata"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="remove_bg" id="remove_bg">
                        Remove image background (isolates main subject)
                    </label>
                </div>
                
                <div class="form-group">
                    <button type="submit" id="upload-button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 16H15M12 12V19M12 12L8 8M12 12L16 8M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Upload Image
                    </button>
                </div>
            </form>
            <div id="upload-result"></div>
            
            <!-- Folder Upload Form -->
            <h2 class="section-title" style="margin-top: 40px;">Upload Folder</h2>
            <form id="folder-upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <div class="file-input-wrapper">
                        <div class="file-input-container">
                            <div class="file-select-button">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Choose Folder
                                <span class="file-name">No folder selected</span>
                                <button type="button" class="remove-file-btn">×</button>
                            </div>
                            <input type="file" name="files" id="folder-files" webkitdirectory directory multiple accept="image/*">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="remove_bg" id="folder-remove-bg">
                        Remove image backgrounds (isolates main subjects)
                    </label>
                </div>
                
                <div class="form-group">
                    <button type="submit" id="folder-upload-button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 16H15M12 12V19M12 12L8 8M12 12L16 8M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Upload Folder
                    </button>
                </div>
            </form>
            <div id="folder-upload-result"></div>
            <div id="folder-upload-progress" class="upload-progress" style="display: none;">
                <div class="progress-container">
                    <p id="progress-text">Processing images...</p>
                    <progress id="progress-bar" value="0" max="100"></progress>
                    <p id="progress-details">Processed 0 of 0 images</p>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Create Filters Section -->
    <section>
        <div class="section-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 4C3 3.44772 3.44772 3 4 3H20C20.5523 3 21 3.44772 21 4V6.58579C21 6.851 20.8946 7.10536 20.7071 7.29289L14.2929 13.7071C14.1054 13.8946 14 14.149 14 14.4142V17L10 21V14.4142C10 14.149 9.89464 13.8946 9.70711 13.7071L3.29289 7.29289C3.10536 7.10536 3 6.851 3 6.58579V4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2>Create Filters</h2>
        </div>
        
        <div class="card">
            <div class="info-text">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 5px;">
                    <path d="M13 16H12V12H11M12 8H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Filters are questions asked about each image. They're useful for filtering search results.
            </div>
            
            <form action="/add-filter" method="post" id="filter-form">
                <div class="form-group">
                    <label for="filter_query">Filter Query (e.g., "Is there a person?")</label>
                    <input type="text" id="filter_query" name="filter_query" required placeholder="Enter a yes/no question about images">
                </div>
                
                <div class="form-group">
                    <button type="submit" id="filter-button">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4V20M20 12L4 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Add Filter
                    </button>
                </div>
            </form>
            <div id="filter-result"></div>
        </div>
    </section>
    
    <!-- Current Filters -->
    <section>
        <div class="section-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15M9 5C9 6.10457 9.89543 7 11 7H13C14.1046 7 15 6.10457 15 5M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5M12 12H15M12 16H15M9 12H9.01M9 16H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h2>Current Filters</h2>
        </div>
        
        <div class="card">
            <div id="filters-container">
                {% for filter in filters %}
                <div class="filter-tag">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 4C3 3.44772 3.44772 3 4 3H20C20.5523 3 21 3.44772 21 4V6.58579C21 6.851 20.8946 7.10536 20.7071 7.29289L14.2929 13.7071C14.1054 13.8946 14 14.149 14 14.4142V17L10 21V14.4142C10 14.149 9.89464 13.8946 9.70711 13.7071L3.29289 7.29289C3.10536 7.10536 3 6.851 3 6.58579V4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    {{ filter }}
                    <form action="/delete-filter" method="post" style="display: inline; margin-left: 8px;">
                        <input type="hidden" name="filter_query" value="{{ filter }}">
                        <button type="submit" class="delete-filter-btn" title="Delete this filter">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% if not filters %}
            <p>No filters created yet. Add one above.</p>
            {% endif %}
        </div>
    </section>
    
    <!-- Progress Modal -->
    <div id="progress-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 500px; width: 90%; text-align: center;">
            <h3 id="progress-title">Processing filter...</h3>
            <p id="progress-message">Please wait while the filter is being applied to all images.</p>
            <div style="margin: 20px 0; background-color: #f0f0f0; border-radius: 8px; height: 16px; overflow: hidden;">
                <div id="progress-bar" style="width: 0%; height: 100%; background-color: #4F46E5; transition: width 0.3s ease;"></div>
            </div>
            <p id="progress-status">Processed <span id="progress-count">0</span> of <span id="progress-total">0</span> images</p>
            <p style="margin-top: 20px; font-size: 0.9em; color: #666;">Please don't navigate away from this page until processing is complete.</p>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // File input handling
            const fileInput = document.getElementById('file');
            const fileButton = document.querySelector('.file-select-button');
            const fileName = document.querySelector('.file-name');
            const removeBtn = document.querySelector('.remove-file-btn');
            
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    fileName.textContent = this.files[0].name;
                    removeBtn.style.display = 'flex';
                } else {
                    fileName.textContent = 'No file selected';
                    removeBtn.style.display = 'none';
                }
            });
            
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                fileInput.value = '';
                fileName.textContent = 'No file selected';
                removeBtn.style.display = 'none';
            });
            
            // Handle upload form submission
            const uploadForm = document.getElementById('upload-form');
            const uploadResult = document.getElementById('upload-result');
            
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(uploadForm);
                const uploadButton = document.getElementById('upload-button');
                uploadButton.disabled = true;
                uploadButton.innerHTML = '<svg class="spinner" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>.spinner{animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}</style><path d="M12 5C8.13401 5 5 8.13401 5 12H3C3 7.02944 7.02944 3 12 3V5ZM12 19C15.866 19 19 15.866 19 12H21C21 16.9706 16.9706 21 12 21V19Z" fill="white"/></svg> Uploading...';
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        uploadResult.innerHTML = `
                            <div style="margin-top: 20px; padding: 15px; background-color: rgba(76, 175, 80, 0.1); color: #2e7d32; border-radius: 8px;">
                                <strong>Success!</strong> Image uploaded successfully.
                            </div>
                        `;
                        uploadForm.reset();
                        fileName.textContent = 'No file selected';
                        removeBtn.style.display = 'none';
                    } else {
                        uploadResult.innerHTML = `
                            <div style="margin-top: 20px; padding: 15px; background-color: rgba(244, 67, 54, 0.1); color: #d32f2f; border-radius: 8px;">
                                <strong>Error:</strong> ${result.detail || 'Failed to upload image'}
                            </div>
                        `;
                    }
                } catch (error) {
                    uploadResult.innerHTML = `
                        <div style="margin-top: 20px; padding: 15px; background-color: rgba(244, 67, 54, 0.1); color: #d32f2f; border-radius: 8px;">
                            <strong>Error:</strong> ${error.message || 'An unexpected error occurred'}
                        </div>
                    `;
                } finally {
                    uploadButton.disabled = false;
                    uploadButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16H15M12 12V19M12 12L8 8M12 12L16 8M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Upload Image';
                }
            });
            
            // Handle filter form submission
            const filterForm = document.getElementById('filter-form');
            const filterResult = document.getElementById('filter-result');
            const filtersContainer = document.getElementById('filters-container');
            
            filterForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(filterForm);
                const filterButton = document.getElementById('filter-button');
                const progressModal = document.getElementById('progress-modal');
                const progressBar = document.getElementById('progress-bar');
                const progressCount = document.getElementById('progress-count');
                const progressTotal = document.getElementById('progress-total');
                const progressTitle = document.getElementById('progress-title');
                const progressMessage = document.getElementById('progress-message');
                
                // Disable button and show loading state
                filterButton.disabled = true;
                filterButton.innerHTML = '<svg class="spinner" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>.spinner{animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}</style><path d="M12 5C8.13401 5 5 8.13401 5 12H3C3 7.02944 7.02944 3 12 3V5ZM12 19C15.866 19 19 15.866 19 12H21C21 16.9706 16.9706 21 12 21V19Z" fill="white"/></svg> Processing...';
                
                try {
                    const response = await fetch('/add-filter', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.text();
                    
                    if (response.ok) {
                        filterResult.innerHTML = `
                            <div style="margin-top: 20px; padding: 15px; background-color: rgba(76, 175, 80, 0.1); color: #2e7d32; border-radius: 8px;">
                                <strong>Success!</strong> Filter added successfully.
                            </div>
                        `;
                        
                        // Add the new filter to the filters container
                        const newFilter = document.createElement('div');
                        newFilter.className = 'filter-tag';
                        newFilter.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 4C3 3.44772 3.44772 3 4 3H20C20.5523 3 21 3.44772 21 4V6.58579C21 6.851 20.8946 7.10536 20.7071 7.29289L14.2929 13.7071C14.1054 13.8946 14 14.149 14 14.4142V17L10 21V14.4142C10 14.149 9.89464 13.8946 9.70711 13.7071L3.29289 7.29289C3.10536 7.10536 3 6.851 3 6.58579V4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            ${formData.get('filter_query')}
                            <form action="/delete-filter" method="post" style="display: inline; margin-left: 8px;">
                                <input type="hidden" name="filter_query" value="${formData.get('filter_query')}">
                                <button type="submit" class="delete-filter-btn" title="Delete this filter">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </form>
                        `;
                        filtersContainer.appendChild(newFilter);
                        
                        // Remove the "no filters" message if it exists
                        const noFiltersMsg = filtersContainer.nextElementSibling;
                        if (noFiltersMsg && noFiltersMsg.tagName === 'P') {
                            noFiltersMsg.style.display = 'none';
                        }
                        
                        filterForm.reset();
                        
                        // Show progress modal
                        progressTitle.textContent = `Processing filter: "${formData.get('filter_query')}"`;
                        progressMessage.textContent = "Please wait while the filter is being applied to all images.";
                        progressModal.style.display = "flex";
                        
                        // Start polling for progress
                        await pollFilterProgress(formData.get('filter_query'));
                    } else {
                        filterResult.innerHTML = `
                            <div style="margin-top: 20px; padding: 15px; background-color: rgba(244, 67, 54, 0.1); color: #d32f2f; border-radius: 8px;">
                                <strong>Error:</strong> Failed to add filter
                            </div>
                        `;
                    }
                } catch (error) {
                    filterResult.innerHTML = `
                        <div style="margin-top: 20px; padding: 15px; background-color: rgba(244, 67, 54, 0.1); color: #d32f2f; border-radius: 8px;">
                            <strong>Error:</strong> ${error.message || 'An unexpected error occurred'}
                        </div>
                    `;
                } finally {
                    filterButton.disabled = false;
                    filterButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 4V20M20 12L4 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Add Filter';
                }
            });
            
            // Function to poll for filter processing progress
            async function pollFilterProgress(filterQuery) {
                const progressModal = document.getElementById('progress-modal');
                const progressBar = document.getElementById('progress-bar');
                const progressCount = document.getElementById('progress-count');
                const progressTotal = document.getElementById('progress-total');
                const progressTitle = document.getElementById('progress-title');
                const progressMessage = document.getElementById('progress-message');
                
                let completed = false;
                
                while (!completed) {
                    try {
                        const response = await fetch(`/filter-progress?filter_query=${encodeURIComponent(filterQuery)}`);
                        const data = await response.json();
                        
                        // Update progress UI
                        progressCount.textContent = data.processed_count;
                        progressTotal.textContent = data.total_count;
                        
                        const percentage = data.total_count > 0 ? (data.processed_count / data.total_count) * 100 : 0;
                        progressBar.style.width = `${percentage}%`;
                        
                        if (data.completed) {
                            progressTitle.textContent = "Processing Complete";
                            progressMessage.textContent = `Successfully applied filter "${filterQuery}" to all images.`;
                            setTimeout(() => {
                                progressModal.style.display = "none";
                            }, 2000);
                            completed = true;
                        } else {
                            // Wait for a moment before polling again
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    } catch (error) {
                        console.error("Error polling for progress:", error);
                        progressMessage.textContent = "Error tracking progress. Processing continues in the background.";
                        setTimeout(() => {
                            progressModal.style.display = "none";
                        }, 3000);
                        completed = true;
                    }
                }
            }
            
            // Folder upload handling
            const folderUploadForm = document.getElementById('folder-upload-form');
            const folderUploadResult = document.getElementById('folder-upload-result');
            const folderUploadProgress = document.getElementById('folder-upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressDetails = document.getElementById('progress-details');
            const folderFiles = document.getElementById('folder-files');
            const folderFileName = folderUploadForm.querySelector('.file-name');
            const folderRemoveBtn = folderUploadForm.querySelector('.remove-file-btn');
            
            // Folder file input event listener
            folderFiles.addEventListener('change', function() {
                if (this.files.length > 0) {
                    folderFileName.textContent = `${this.files.length} files selected`;
                    folderRemoveBtn.style.display = 'inline-block';
                } else {
                    folderFileName.textContent = 'No folder selected';
                    folderRemoveBtn.style.display = 'none';
                }
            });
            
            // Folder remove button event listener
            folderRemoveBtn.addEventListener('click', function() {
                folderFiles.value = '';
                folderFileName.textContent = 'No folder selected';
                folderRemoveBtn.style.display = 'none';
            });
            
            folderUploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const files = folderFiles.files;
                if (files.length === 0) {
                    folderUploadResult.innerHTML = `
                        <div style="margin-top: 20px; padding: 15px; background-color: rgba(244, 67, 54, 0.1); color: #d32f2f; border-radius: 8px;">
                            <strong>Error:</strong> Please select a folder with images.
                        </div>
                    `;
                    return;
                }
                
                // Filter for image files only
                const imageFiles = Array.from(files).filter(file => 
                    file.type.startsWith('image/') || 
                    file.name.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i)
                );
                
                if (imageFiles.length === 0) {
                    folderUploadResult.innerHTML = `
                        <div style="margin-top: 20px; padding: 15px; background-color: rgba(244, 67, 54, 0.1); color: #d32f2f; border-radius: 8px;">
                            <strong>Error:</strong> No image files found in the selected folder.
                        </div>
                    `;
                    return;
                }
                
                // Show blocking UI
                folderUploadProgress.style.display = 'flex';
                progressBar.max = imageFiles.length;
                progressBar.value = 0;
                progressText.textContent = `Processing images...`;
                progressDetails.textContent = `Processed 0 of ${imageFiles.length} images`;
                
                const folderUploadButton = document.getElementById('folder-upload-button');
                folderUploadButton.disabled = true;
                folderUploadButton.innerHTML = '<svg class="spinner" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>.spinner{animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}</style><path d="M12 5C8.13401 5 5 8.13401 5 12H3C3 7.02944 7.02944 3 12 3V5ZM12 19C15.866 19 19 15.866 19 12H21C21 16.9706 16.9706 21 12 21V19Z" fill="white"/></svg> Uploading...';
                
                try {
                    const removeBg = document.getElementById('folder-remove-bg').checked;
                    let processedCount = 0;
                    let failedCount = 0;
                    
                    // Process files in batches to avoid overwhelming the server
                    const batchSize = 5;
                    const totalBatches = Math.ceil(imageFiles.length / batchSize);
                    
                    for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                        const start = batchIndex * batchSize;
                        const end = Math.min(start + batchSize, imageFiles.length);
                        const batchFiles = imageFiles.slice(start, end);
                        
                        const formData = new FormData();
                        batchFiles.forEach(file => {
                            formData.append('files', file);
                        });
                        formData.append('remove_bg', removeBg);
                        
                        const response = await fetch('/upload-folder', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            processedCount += result.processed;
                            failedCount += result.failed;
                            
                            // Update progress
                            progressBar.value = processedCount;
                            progressText.textContent = `Processing images... ${Math.round((processedCount / imageFiles.length) * 100)}%`;
                            progressDetails.textContent = `Processed ${processedCount} of ${imageFiles.length} images`;
                        } else {
                            throw new Error(result.detail || 'Failed to upload images');
                        }
                    }
                    
                    // Hide progress UI
                    folderUploadProgress.style.display = 'none';
                    
                    // Show result message
                    folderUploadResult.innerHTML = `
                        <div style="margin-top: 20px; padding: 15px; background-color: rgba(76, 175, 80, 0.1); color: #2e7d32; border-radius: 8px;">
                            <strong>Success!</strong> Processed ${processedCount} images${failedCount > 0 ? ` (${failedCount} failed)` : ''}.
                        </div>
                    `;
                    
                    // Reset form
                    folderUploadForm.reset();
                    folderFileName.textContent = 'No folder selected';
                    folderRemoveBtn.style.display = 'none';
                    
                } catch (error) {
                    // Hide progress UI
                    folderUploadProgress.style.display = 'none';
                    
                    folderUploadResult.innerHTML = `
                        <div style="margin-top: 20px; padding: 15px; background-color: rgba(244, 67, 54, 0.1); color: #d32f2f; border-radius: 8px;">
                            <strong>Error:</strong> ${error.message || 'An unexpected error occurred'}
                        </div>
                    `;
                } finally {
                    folderUploadButton.disabled = false;
                    folderUploadButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16H15M12 12V19M12 12L8 8M12 12L16 8M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Upload Folder';
                }
            });
        });
    </script>
</body>
</html> 